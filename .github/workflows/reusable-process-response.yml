# Reusable workflow: Process contributor response and create registry entry
name: Process Contributor Response

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull request number'
        required: true
        type: number
      repo_name:
        description: 'Repository name (owner/repo)'
        required: true
        type: string
      pr_author:
        description: 'PR author username'
        required: true
        type: string
      pr_title:
        description: 'PR title'
        required: true
        type: string
      lines_changed:
        description: 'Total lines changed'
        required: true
        type: number
    secrets:
      GIST_PAT:
        required: true

permissions:
  pull-requests: write
  issues: write
  contents: write

jobs:
  process_response:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout automation scripts
        uses: actions/checkout@v4
        with:
          repository: StabilityNexus/ContributorAutomation
          path: automation
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install -r automation/requirements.txt
      
      # Fetch all PR comments and extract author's discord/wallet
      - name: Fetch and validate author comments
        id: extract
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          PR_AUTHOR: ${{ inputs.pr_author }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = parseInt(process.env.PR_NUMBER, 10);
            const prAuthor = process.env.PR_AUTHOR;
            
            // Fetch PR details to check labels
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber,
            });
            
            // Must be merged
            if (!pr.merged) {
              console.log("PR not merged, skipping");
              core.setOutput('skip', 'true');
              core.setOutput('skip_reason', 'not_merged');
              return;
            }
            
            // Must have first-time-contributor label
            const hasLabel = pr.labels.some(label => 
              label.name === 'first-time-contributor' || label.name === 'first-contribution'
            );
            if (!hasLabel) {
              console.log("Not a first-time contributor PR, skipping");
              core.setOutput('skip', 'true');
              core.setOutput('skip_reason', 'not_first_time');
              return;
            }
            
            // Fetch all comments from the PR
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: prNumber,
            });
            
            console.log(`Total comments: ${comments.length}`);
            
            // Filter only PR author's comments (ignore all others silently - no warnings)
            const authorComments = comments.filter(comment => comment.user.login === prAuthor);
            console.log(`Author comments: ${authorComments.length}`);
            
            // Search for discord and wallet in author's comments only
            let discordId = null;
            let wallet = null;
            
            for (const comment of authorComments) {
              const body = comment.body;
              
              const discordMatch = body.match(/discord:\s*["\']?(\d{17,20})["\']?/i);
              if (discordMatch && !discordId) {
                discordId = discordMatch[1];
              }
              
              const walletMatch = body.match(/wallet:\s*["\']?(0x[a-fA-F0-9]{40})["\']?/i);
              if (walletMatch && !wallet) {
                wallet = walletMatch[1];
              }
              
              if (discordId && wallet) break;
            }
            
            // Set outputs
            if (discordId && wallet) {
              core.setOutput('skip', 'false');
              core.setOutput('discord_id', discordId);
              core.setOutput('wallet', wallet);
              console.log(`‚úì Found valid info from author`);
            } else {
              core.setOutput('skip', 'true');
              core.setOutput('skip_reason', 'missing_info');
              console.log(`‚úó Missing info - Discord: ${!!discordId}, Wallet: ${!!wallet}`);
            }
      
      # Check if already exists
      - name: Check if already onboarded
        if: steps.extract.outputs.skip == 'false'
        id: check
        env:
          GIST_PAT: ${{ secrets.GIST_PAT }}
          PR_AUTHOR: ${{ inputs.pr_author }}
        run: |
          cd automation
          python scripts/contributor_manager.py \
            --action check_exists \
            --username "$PR_AUTHOR" \
            --gist-pat "$GIST_PAT" \
            --output-file ../check_result.json
          
          if [ -f ../check_result.json ]; then
            EXISTS=$(jq -r '.exists' ../check_result.json)
            echo "exists=$EXISTS" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      # Get author's commit email
      - name: Get author commit email
        if: steps.extract.outputs.skip == 'false' && steps.check.outputs.exists == 'false'
        id: author_info
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = parseInt(process.env.PR_NUMBER, 10);
            
            // Get commits from the PR
            const { data: commits } = await github.rest.pulls.listCommits({
              owner,
              repo,
              pull_number: prNumber,
            });
            
            // Get the author's email from the first commit
            const authorEmail = commits.length > 0 && commits[0].commit.author.email 
              ? commits[0].commit.author.email 
              : 'N/A';
            
            core.setOutput('author_email', authorEmail);
            console.log(`Author email: ${authorEmail}`);
      
      # Checkout target repository to update contributors.md
      - name: Checkout target repository
        if: steps.extract.outputs.skip == 'false' && steps.check.outputs.exists == 'false'
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo_name }}
          token: ${{ secrets.GIST_PAT }}
          path: target-repo
      
      # Configure Git for commits
      - name: Configure Git
        if: steps.extract.outputs.skip == 'false' && steps.check.outputs.exists == 'false'
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "GitHub Actions Bot"
      
      # Update contributors.md file
      - name: Update contributors.md
        if: steps.extract.outputs.skip == 'false' && steps.check.outputs.exists == 'false'
        env:
          PR_AUTHOR: ${{ inputs.pr_author }}
          AUTHOR_EMAIL: ${{ steps.author_info.outputs.author_email }}
          DISCORD_ID: ${{ steps.extract.outputs.discord_id }}
          WALLET: ${{ steps.extract.outputs.wallet }}
          PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          cd target-repo
          
          # Create contributors.md if it doesn't exist
          if [ ! -f contributors.md ]; then
            echo "# Contributors" > contributors.md
            echo "" >> contributors.md
            echo "List of contributors who have successfully completed onboarding." >> contributors.md
            echo "" >> contributors.md
            echo "| GitHub Username | GitHub Email |" >> contributors.md
            echo "|-----------------|--------------|" >> contributors.md
          fi
          
          # Add contributor entry
          echo "| @$PR_AUTHOR | $AUTHOR_EMAIL |" >> contributors.md
          
          # Commit and push
          git add contributors.md
          git commit -m "chore: add contributor @$PR_AUTHOR to registry"
          git push
      
      # Create contributor entry in Gist
      - name: Create contributor entry
        if: steps.extract.outputs.skip == 'false' && steps.check.outputs.exists == 'false'
        env:
          GIST_PAT: ${{ secrets.GIST_PAT }}
          PR_NUMBER: ${{ inputs.pr_number }}
          REPO_NAME: ${{ inputs.repo_name }}
          PR_AUTHOR: ${{ inputs.pr_author }}
          DISCORD_ID: ${{ steps.extract.outputs.discord_id }}
          WALLET: ${{ steps.extract.outputs.wallet }}
          PR_TITLE: ${{ inputs.pr_title }}
          LINES_CHANGED: ${{ inputs.lines_changed }}
        run: |
          cd automation
          python scripts/contributor_manager.py \
            --action create \
            --username "$PR_AUTHOR" \
            --discord-id "$DISCORD_ID" \
            --wallet "$WALLET" \
            --pr-number "$PR_NUMBER" \
            --repo-name "$REPO_NAME" \
            --pr-title "$PR_TITLE" \
            --lines-changed "$LINES_CHANGED" \
            --labels "[]" \
            --gist-pat "$GIST_PAT"
      
      # Post success message
      - name: Post success message
        if: steps.extract.outputs.skip == 'false' && steps.check.outputs.exists == 'false'
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          PR_AUTHOR: ${{ inputs.pr_author }}
          DISCORD_ID: ${{ steps.extract.outputs.discord_id }}
          WALLET: ${{ steps.extract.outputs.wallet }}
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(process.env.PR_NUMBER, 10),
              body: `üéâ **Onboarding complete!**\n\nThank you @${process.env.PR_AUTHOR}! Your information has been saved.\n\n**Your Stats:**\n- Total PRs: 1\n- Discord: \`${process.env.DISCORD_ID}\`\n- Wallet: \`${process.env.WALLET}\``
            });
      
      # Post error message if info not found
      - name: Post error message && steps.extract.outputs.skip_reason == 'missing_info'
        if: steps.extract.outputs.skip == 'true'
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          PR_AUTHOR: ${{ inputs.pr_author }}
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(process.env.PR_NUMBER, 10),
              body: `‚ö†Ô∏è **Onboarding incomplete** @${process.env.PR_AUTHOR}\n\nWe couldn't find valid onboarding information in your PR comments.\n\nPlease provide:\n\`\`\`\ndiscord: YOUR_DISCORD_ID\nwallet: YOUR_WALLET_ADDRESS\n\`\`\`\n\nContact a maintainer for assistance.`
            });
      
      - name: Already onboarded
        if: steps.extract.outputs.skip == 'false' && steps.check.outputs.exists == 'true'
        run: echo "[INFO] Contributor already onboarded. Skipping."