# Reusable workflow: Request contributor info on first merged PR
name: Request Contributor Info

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull request number'
        required: true
        type: number
      repo_name:
        description: 'Repository name (owner/repo)'
        required: true
        type: string
      pr_author:
        description: 'PR author username'
        required: true
        type: string
    secrets:
      GIST_PAT:
        required: true

permissions:
  pull-requests: write
  issues: write

jobs:
  request_info:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout automation scripts
        uses: actions/checkout@v4
        with:
          repository: StabilityNexus/ContributorAutomation
          path: automation
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install -r automation/requirements.txt
      
      # Check if contributor already exists
      - name: Check if already onboarded
        id: check
        env:
          GIST_PAT: ${{ secrets.GIST_PAT }}
          PR_AUTHOR: ${{ inputs.pr_author }}
        run: |
          cd automation
          python scripts/contributor_manager.py \
            --action check_exists \
            --username "$PR_AUTHOR" \
            --gist-pat "$GIST_PAT" \
            --output-file ../check_result.json
          
          if [ -f ../check_result.json ]; then
            EXISTS=$(jq -r '.exists' ../check_result.json)
            echo "exists=$EXISTS" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      # Post comment asking for info (if not already onboarded)
      - name: Request Discord and wallet info
        if: steps.check.outputs.exists == 'false'
        uses: actions/github-script@v7
        env:
          PR_AUTHOR: ${{ inputs.pr_author }}
          PR_NUMBER: ${{ inputs.pr_number }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const prAuthor = process.env.PR_AUTHOR;
            const comment = `ðŸŽ‰ **Congratulations @${prAuthor} on your first merged PR!**
            
            To complete your onboarding, please provide:
            
            1. **Discord User ID** (17-20 digits)
            2. **Wallet Address** (should be non-custodial wallet)
            
            **Format (copy and fill):**
            \`\`\`
            discord: "YOUR_DISCORD_ID"
            wallet: "YOUR_WALLET_ADDRESS"
            \`\`\`
            
            **How to find your Discord ID:**
            - Enable Developer Mode: Settings â†’ Advanced â†’ Developer Mode
            - Right-click your username â†’ Copy User ID
            
            **Example:**
            \`\`\`
            discord: "123456789012345678"
            wallet: "0x1234567890abcdef1234567890abcdef12345678"
            \`\`\`
            
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: parseInt(process.env.PR_NUMBER, 10),
              body: comment
            });
      
      - name: Already onboarded  
        if: steps.check.outputs.exists == 'true'
        run: echo "âœ“ Contributor already onboarded"
